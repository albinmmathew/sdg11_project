{% extends 'issues/base.html' %}
{% block content %}

<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">

        <div class="card shadow-sm border-0 p-4 p-md-5">

            <!-- HEADER -->
            <h3 class="fw-bold mb-1">Report a Civic Issue</h3>
            <p class="text-muted mb-4">
                Help improve your community by reporting issues that need attention from local authorities.
            </p>

            <!-- FORM -->
            <form method="post">
                {% csrf_token %}

                <!-- CATEGORY -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">
                        Issue Category <span class="text-danger">*</span>
                    </label>
                    <select name="category" id="categorySelect"
                            class="form-select" required>
                        <option value="">Select a category</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- EMERGENCY ALERT -->
                <div id="emergencyBox" class="alert alert-danger d-none mb-4">
                    <strong>âš  Emergency Issue</strong><br>
                    This issue requires immediate action.<br>
                    Please contact emergency services:
                    <br>
                    ðŸ“ž <strong id="helplineNumber"></strong>
                </div>

                <!-- TITLE -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">
                        Issue Title <span class="text-danger">*</span>
                    </label>
                    <input type="text"
                           name="title"
                           class="form-control"
                           placeholder="Brief title describing the issue"
                           required>
                </div>

                <!-- DESCRIPTION -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">
                        Description <span class="text-danger">*</span>
                    </label>
                    <textarea name="description"
                              class="form-control"
                              rows="4"
                              placeholder="Provide detailed information about the issue"
                              required></textarea>
                </div>

                <!-- LOCATION -->
                <div class="mb-5">
                    <label class="form-label fw-semibold">
                        Location <span class="text-danger">*</span>
                    </label>
                    <input type="text"
                           name="location"
                           class="form-control"
                           placeholder="Street address or landmark"
                           required>
                </div>

                <!-- ACTIONS -->
                <div class="d-flex gap-3">
                    <button type="submit"
                            class="btn btn-dark px-5 flex-grow-1">
                        Submit Issue
                    </button>

                    <a href="{% url 'issue_list' %}"
                       class="btn btn-outline-secondary px-4">
                        Cancel
                    </a>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- AJAX EMERGENCY HANDLER -->
<script>
document.getElementById('categorySelect').addEventListener('change', function () {
    const categoryId = this.value;
    const box = document.getElementById('emergencyBox');
    const phone = document.getElementById('helplineNumber');

    if (!categoryId) {
        box.classList.add('d-none');
        phone.innerText = '';
        return;
    }

    fetch(`/issues/ajax/category-info/?category_id=${categoryId}`)
        .then(res => res.json())
        .then(data => {
            if (data.is_emergency && data.helpline) {
                phone.innerText = data.helpline;
                box.classList.remove('d-none');
            } else {
                box.classList.add('d-none');
                phone.innerText = '';
            }
        });
});
</script>

{% endblock %}
